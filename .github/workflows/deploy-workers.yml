name: Deploy Cloudflare Workers

on:
  push:
    branches:
      - main
    paths:
      - 'workers/**'
      - '.github/workflows/deploy-workers.yml'
  workflow_dispatch: # Allow manual triggering

jobs:
  # Discover all worker directories
  find-workers:
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.get-workers.outputs.workers }}
      worker-count: ${{ steps.get-workers.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find all workers
        id: get-workers
        run: |
          # Find all directories in workers/ (excluding hidden files)
          workers=$(find workers -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          count=$(echo "$workers" | jq 'length')

          echo "workers=$workers" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT

          echo "üì¶ Found $count worker(s) to deploy:"
          echo "$workers" | jq -r '.[]' | sed 's/^/  - /'

  # Deploy all discovered workers
  deploy:
    needs: find-workers
    runs-on: ubuntu-latest
    if: needs.find-workers.outputs.worker-count > 0

    strategy:
      matrix:
        worker: ${{ fromJson(needs.find-workers.outputs.workers) }}
      fail-fast: false  # Continue deploying other workers even if one fails

    name: Deploy ${{ matrix.worker }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Check if ANTHROPIC_API_KEY is needed
        id: check-secrets
        run: |
          # Check if worker code references ANTHROPIC_API_KEY
          if grep -q "ANTHROPIC_API_KEY" workers/${{ matrix.worker }}/index.js 2>/dev/null; then
            echo "needs-api-key=true" >> $GITHUB_OUTPUT
            echo "üîë Worker uses ANTHROPIC_API_KEY - will configure secret"
          else
            echo "needs-api-key=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Worker does not use ANTHROPIC_API_KEY - skipping secret configuration"
          fi

      - name: Set ANTHROPIC_API_KEY secret
        if: steps.check-secrets.outputs.needs-api-key == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | wrangler secret put ANTHROPIC_API_KEY

      - name: Deploy worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd workers/${{ matrix.worker }}
          wrangler deploy

      - name: Deployment summary
        run: |
          echo "‚úÖ Worker '${{ matrix.worker }}' deployed successfully!"
          echo "üåê Worker URL: https://${{ matrix.worker }}.zammel.workers.dev"

  # Summary of all deployments
  summary:
    needs: [find-workers, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment summary
        run: |
          echo "üéâ Deployment complete!"
          echo "üì¶ Total workers deployed: ${{ needs.find-workers.outputs.worker-count }}"
          echo ""
          echo "Workers:"
          echo '${{ needs.find-workers.outputs.workers }}' | jq -r '.[] | "  ‚úì https://\(.).zammel.workers.dev"'
